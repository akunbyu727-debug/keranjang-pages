<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ‚Äì Koleksiku</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body{
      margin:0;
      padding:20px;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#0b1622;
      color:#fff;
    }
    .wrap{
      max-width:620px;
      margin:0 auto;
    }
    h1{
      text-align:center;
      margin-bottom:10px;
      font-size:24px;
    }
    .sub{
      text-align:center;
      font-size:13px;
      color:#c3d0df;
      margin-bottom:18px;
    }
    .tabs{
      display:flex;
      margin-bottom:16px;
      border-radius:12px;
      overflow:hidden;
      background:#111d2a;
    }
    .tab{
      flex:1;
      text-align:center;
      padding:10px 0;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      color:#9fb0c4;
      border-bottom:2px solid transparent;
    }
    .tab.active{
      background:#ff7f00;
      color:#fff;
      border-bottom-color:#ffd8aa;
    }
    .panel{
      display:none;
    }
    .panel.active{
      display:block;
    }
    .box{
      background:#111d2a;
      padding:14px;
      border-radius:12px;
      margin-bottom:14px;
      box-shadow:0 3px 12px rgba(0,0,0,0.35);
    }
    .box h2{
      margin:0 0 6px;
      font-size:16px;
    }
    .box p{
      margin:4px 0 8px;
      font-size:13px;
      color:#c3d0df;
    }
    textarea{
      width:100%;
      min-height:110px;
      resize:vertical;
      border-radius:8px;
      border:none;
      padding:10px;
      font-size:13px;
      font-family:inherit;
      box-sizing:border-box;
      outline:none;
    }
    textarea:focus{
      outline:2px solid #ff7f00;
    }
    button{
      padding:10px 18px;
      border:none;
      border-radius:999px;
      background:#ff7f00;
      color:#fff;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      margin-top:8px;
    }
    button:hover{
      background:#ff9933;
    }
    .log{
      background:#050910;
      border-radius:10px;
      padding:10px;
      font-size:12px;
      white-space:pre-line;
      max-height:260px;
      overflow:auto;
      border:1px solid #1f2937;
    }
    .log-title{
      font-size:13px;
      margin:12px 0 4px;
      color:#c3d0df;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Admin ‚Äì Koleksiku</h1>
    <div class="sub">Tambah produk ke Sheet ‚Ä¢ Shopee auto judul + gambar, TikTok batch</div>

    <!-- TABS -->
    <div class="tabs">
      <div id="tab-shopee" class="tab active" onclick="setTab('shopee')">üõí Shopee</div>
      <div id="tab-tiktok" class="tab" onclick="setTab('tiktok')">üéµ TikTok</div>
    </div>

    <!-- PANEL SHOPEE -->
    <div id="panel-shopee" class="panel active">
      <div class="box">
        <h2>üõí Tambah Shopee (Auto Nama + Gambar)</h2>
        <p>Tempel link Shopee satu per baris. Sistem akan ambil <b>judul & gambar utama</b> otomatis, lalu simpan ke Sheet (A‚ÄìD) dengan nomor urut baru.</p>
        <textarea id="shopee-input" placeholder="https://s.shopee.co.id/....&#10;https://shopee.co.id/product/..."></textarea>
        <button onclick="sendShopee()">Tambah Produk Shopee</button>
      </div>
    </div>

    <!-- PANEL TIKTOK -->
    <div id="panel-tiktok" class="panel">
      <div class="box">
        <h2>üéµ Tambah TikTok (Batch H‚ÄìN)</h2>
        <p>Link TikTok (1 per baris):</p>
        <textarea id="tiktok-links" placeholder="https://www.tiktok.com/....&#10;https://vt.tiktok.com/..."></textarea>

        <p>Judul (optional, 1 per baris ‚Äì boleh dikosongkan, akan digantikan 'Produk'):</p>
        <textarea id="tiktok-titles" placeholder="Nama produk 1&#10;Nama produk 2"></textarea>

        <p>URL gambar (optional, 1 per baris):</p>
        <textarea id="tiktok-images" placeholder="https://...jpg&#10;https://...jpg"></textarea>

        <button onclick="sendTikTok()">Tambah Produk TikTok</button>
      </div>
    </div>

    <!-- LOG -->
    <div class="log-title">üìú Log proses</div>
    <div id="log" class="log">Siap menerima perintah‚Ä¶</div>
  </div>

  <script>
    // üîó GUNAKAN WEB APP BARU YANG SUDAH KAMU KIRIM
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzIjOcuTdCvc_BSOaHx-L7DEmpHVmwHbGCVVaMpX0g21I02WhRPocCce12daDdfMpdU/exec";

    function setTab(name){
      document.getElementById("tab-shopee").classList.toggle("active", name === "shopee");
      document.getElementById("tab-tiktok").classList.toggle("active", name === "tiktok");
      document.getElementById("panel-shopee").classList.toggle("active", name === "shopee");
      document.getElementById("panel-tiktok").classList.toggle("active", name === "tiktok");
    }

    function log(msg){
      const box = document.getElementById("log");
      box.textContent += "\\n" + msg;
      box.scrollTop = box.scrollHeight;
    }

    // ==========================================================
    //  SHOPEE: auto meta (judul + gambar) mirip bookmark
    // ==========================================================
    async function fetchShopeeMeta(url){
      try {
        // Proxy sederhana untuk bypass CORS
        const proxied = "https://cors.isomorphic-git.org/" + url;
        const resp = await fetch(proxied);
        const html = await resp.text();

        let title = "Produk";
        let image = "";

        // OG:title
        const t = html.match(/<meta[^>]+property=[\"']og:title[\"'][^>]+content=[\"']([^\"']+)[\"']/i);
        if (t) title = t[1];

        // OG:image
        const i = html.match(/<meta[^>]+property=[\"']og:image[\"'][^>]+content=[\"']([^\"']+)[\"']/i);
        if (i) image = i[1];

        return { title, image };
      } catch(err){
        console.log("Gagal fetch Shopee meta:", err);
        return { title: "Produk", image: "" };
      }
    }

    async function sendShopee(){
      const raw = document.getElementById("shopee-input").value.trim();
      const logBox = document.getElementById("log");
      logBox.textContent = "‚è≥ Mulai proses Shopee...\\n";

      if(!raw){
        alert("Isi link Shopee dulu, bro.");
        return;
      }

      const links = raw.split(/\\r?\\n/).map(x => x.trim()).filter(Boolean);
      let idx = 0;

      for (const link of links){
        idx++;
        log("[" + idx + "/" + links.length + "] Ambil meta: " + link);

        const meta = await fetchShopeeMeta(link);
        log("   ‚Üí title: " + meta.title);

        const qs = new URLSearchParams({
          link: link,
          title: meta.title || "Produk",
          image: meta.image || "",
          no: "",
          source: "shopee"
        });

        try {
          const res = await fetch(WEBAPP_URL + "?" + qs.toString());
          const txt = await res.text();
          log("   ‚úî Disimpan ‚Üí " + txt);
        } catch(err){
          log("   ‚úñ Gagal simpan: " + err);
        }

        // delay sedikit biar gak ngebom Apps Script / proxy
        await new Promise(r => setTimeout(r, 400));
      }

      log("\\nüéâ Selesai tambah Shopee.");
    }

    // ==========================================================
    //  TIKTOK: tetap batch, kirim ke handleBatch di Apps Script
    // ==========================================================
    async function sendTikTok(){
      const links  = document.getElementById("tiktok-links").value.trim();
      const titles = document.getElementById("tiktok-titles").value.trim();
      const images = document.getElementById("tiktok-images").value.trim();
      const logBox = document.getElementById("log");
      logBox.textContent = "‚è≥ Mulai proses TikTok...\\n";

      if(!links){
        alert("Isi minimal link TikTok dulu.");
        return;
      }

      const qs = new URLSearchParams({
        mode: "batch",
        source: "tiktok",
        links,
        titles,
        images
      });

      try {
        const res = await fetch(WEBAPP_URL + "?" + qs.toString());
        const txt = await res.text();
        log("‚úî TikTok batch ‚Üí " + txt);
      } catch(err){
        log("‚úñ ERROR TikTok: " + err);
      }

      log("\\nüéâ Selesai TikTok.");
    }
  </script>
</body>
</html>
