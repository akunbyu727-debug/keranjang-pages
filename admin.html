<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin JSON Keranjang</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e5e7eb}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:16px;margin-bottom:14px}
    textarea{width:100%;min-height:200px;border-radius:12px;border:1px solid #374151;background:#0b1220;color:#e5e7eb;padding:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input,button{padding:10px;border-radius:12px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
    button.primary{background:#ff7a3d;border-color:#d45c21;color:#000;font-weight:800}
    .list{font-family:ui-monospace,Consolas,monospace;font-size:13px;white-space:pre-wrap;background:#0b1220;border:1px solid #374151;border-radius:12px;padding:12px}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Admin JSON Keranjang</h1>
    <div class="card">
      <p><b>1) Muat JSON lama</b> (opsional, pilih <code>products.json</code> dari repo untuk ditambah):</p>
      <input type="file" id="pickOld" accept="application/json" />
      <div id="oldCount" class="muted"></div>
    </div>

    <div class="card">
      <p><b>2) Paste teks Shopee/TikTok caption</b> (alat ini otomatis ekstrak semua link dan memberi nomor berurutan):</p>
      <textarea id="paste" placeholder="Contoh:\nYuk kita spill 👇\n👔 Atasan: https://s.shopee.co.id/AAAA\n👖 Celana: https://s.shopee.co.id/BBBB\n👜 Tas: https://s.shopee.co.id/CCCC"></textarea>
      <div class="row">
        <input id="startNo" type="number" value="1" min="1" />
        <input id="defaultImg" placeholder="URL gambar default (opsional)" />
      </div>
      <button id="preview" class="primary">Preview</button>
    </div>

    <div class="card">
      <p><b>3) Hasil</b> (gabungan lama+baru). Klik <i>Download</i> untuk menyimpan <code>products.json</code> lalu commit ke GitHub.</p>
      <div id="result" class="list"></div>
      <button id="download" class="primary">Download products.json</button>
    </div>
  </main>

  <script>
    const pickOld = document.getElementById('pickOld');
    const paste = document.getElementById('paste');
    const result = document.getElementById('result');
    const startNo = document.getElementById('startNo');
    const defaultImg = document.getElementById('defaultImg');
    let OLD=[];

    pickOld.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const txt = await f.text();
      try{ OLD = JSON.parse(txt); if(!Array.isArray(OLD)) OLD = OLD.items||[]; }catch{ OLD=[] }
      document.getElementById('oldCount').textContent = `Memuat ${OLD.length} item lama.`;
    });

    function extractPairs(text){
      const urlRe = /(https?:\/\/[\w.-]+\.[\w.-]+\/[\w\-\/?#=&%+.,]+)/gi;
      const lines = text.split(/\n+/);
      const items=[];
      let lastLabel='';
      for(const line of lines){
        const links = [...line.matchAll(urlRe)].map(m=>m[1]);
        const label = line.replace(urlRe,'').trim();
        if(label) lastLabel = label.replace(/^[\-•*🛒📎✦◇▶️\s]+/,'');
        for(const link of links){
          items.push({name:lastLabel||'Item',link});
        }
      }
      return items;
    }

    function merge(oldArr,newArr,start){
      const maxNo = oldArr.reduce((m,it)=>Math.max(m,Number(it.no||0)),0);
      let n = Math.max(maxNo+1, Number(start)||1);
      return [
        ...oldArr,
        ...newArr.map(it=>({
          id: crypto.randomUUID?.()||String(Date.now())+Math.random(),
          no: n++,
          name: it.name?.replace(/\s*[:：-]$/,'')||'Item',
          link: it.link,
          image: it.image||defaultImg.value||'',
          price: it.price||'',
          tags: it.tags||[],
          created_at: new Date().toISOString().replace('T',' ').slice(0,19)
        }))
      ];
    }

    document.getElementById('preview').addEventListener('click',()=>{
      const pairs = extractPairs(paste.value||'');
      const merged = merge(OLD,pairs,startNo.value);
      result.textContent = JSON.stringify(merged,null,2);
      window._merged = merged;
    });

    document.getElementById('download').addEventListener('click',()=>{
      const data = window._merged||[];
      const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a = Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'products.json'});
      a.click(); URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
